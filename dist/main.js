var V=Object.create;var C=Object.defineProperty,z=Object.defineProperties,X=Object.getOwnPropertyDescriptor,F=Object.getOwnPropertyDescriptors,q=Object.getOwnPropertyNames,P=Object.getOwnPropertySymbols,G=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var H=(i,t,e)=>t in i?C(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,N=(i,t)=>{for(var e in t||(t={}))j.call(t,e)&&H(i,e,t[e]);if(P)for(var e of P(t))Y.call(t,e)&&H(i,e,t[e]);return i},K=(i,t)=>z(i,F(t)),J=i=>C(i,"__esModule",{value:!0});var _=(i,t)=>{J(i);for(var e in t)C(i,e,{get:t[e],enumerable:!0})},Q=(i,t,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of q(t))!j.call(i,n)&&n!=="default"&&C(i,n,{get:()=>t[n],enumerable:!(e=X(t,n))||e.enumerable});return i},f=i=>Q(J(C(i!=null?V(G(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);var u=(i,t,e)=>new Promise((n,a)=>{var r=c=>{try{d(e.next(c))}catch(o){a(o)}},s=c=>{try{d(e.throw(c))}catch(o){a(o)}},d=c=>c.done?n(c.value):Promise.resolve(c.value).then(r,s);d((e=e.apply(i,t)).next())});_(exports,{default:()=>O});var T=f(require("obsidian"));var B=f(require("child_process")),W=f(require("util"));var g=f(require("obsidian")),U=(0,W.promisify)(B.exec),I=class{constructor(){this.isMac=g.Platform.isMacOS}checkMacOS(){return this.isMac?!0:(new g.Notice("\u6B64\u529F\u80FD\u4EC5\u652F\u6301 macOS \u7CFB\u7EDF"),!1)}runJXA(t){return u(this,null,function*(){if(!this.checkMacOS())return null;try{let{stdout:e}=yield U(`osascript -l JavaScript -e '${t}'`,{timeout:6e4});return e.trim()}catch(e){return console.error("[Calendar] JXA Error:",e),new g.Notice("\u6267\u884C\u65E5\u5386\u64CD\u4F5C\u5931\u8D25"),null}})}escapeJXA(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n")}getEvents(){return u(this,null,function*(){let t='ObjC.import("EventKit");var store=$.EKEventStore.alloc.init;var status=$.EKEventStore.authorizationStatusForEntityType(0);if(status!=3){store.requestAccessToEntityTypeCompletion(0,null);delay(2);}var now=$.NSDate.date;var end=now.dateByAddingTimeInterval(3*24*60*60);var cals=store.calendarsForEntityType(0);var calNames=[];var events={};for(var i=0;i<cals.count;i++){var cal=cals.objectAtIndex(i);var name=ObjC.unwrap(cal.title);calNames.push(name);}var predicate=store.predicateForEventsWithStartDateEndDateCalendars(now,end,cals);var allEvents=store.eventsMatchingPredicate(predicate);for(var i=0;i<allEvents.count;i++){var e=allEvents.objectAtIndex(i);var calName=ObjC.unwrap(e.calendar.title);if(!events[calName])events[calName]=[];events[calName].push({title:ObjC.unwrap(e.title),id:ObjC.unwrap(e.calendarItemIdentifier),start:ObjC.unwrap(e.startDate).toISOString(),end:ObjC.unwrap(e.endDate).toISOString(),allDay:e.isAllDay,location:e.location?ObjC.unwrap(e.location):null,notes:e.notes?ObjC.unwrap(e.notes):null});}for(var k in events){events[k].sort(function(a,b){return new Date(a.start)-new Date(b.start);});}JSON.stringify({events:events,calendars:calNames});',e=yield this.runJXA(t);if(!e)return{events:{},calendars:[]};try{return JSON.parse(e)}catch(n){return console.error("[Calendar] Parse Error:",n),{events:{},calendars:[]}}})}getCalendars(){return u(this,null,function*(){let t='var Calendar=Application("Calendar");JSON.stringify(Calendar.calendars().map(function(c){return c.name();}));',e=yield this.runJXA(t);if(!e)return[];try{return JSON.parse(e)}catch(n){return[]}})}createEvent(t,e,n,a){return u(this,null,function*(){let r=this.escapeJXA(t),s=this.escapeJXA(e),d=`ObjC.import("EventKit");var store=$.EKEventStore.alloc.init;var status=$.EKEventStore.authorizationStatusForEntityType(0);if(status!=3){store.requestAccessToEntityTypeCompletion(0,null);delay(2);}var cals=store.calendarsForEntityType(0);var targetCal=null;for(var i=0;i<cals.count;i++){var cal=cals.objectAtIndex(i);if(ObjC.unwrap(cal.title)==="${r}"){targetCal=cal;break;}}if(!targetCal){var names=[];for(var i=0;i<cals.count;i++){names.push(ObjC.unwrap(cals.objectAtIndex(i).title));}"calendar not found. Available: "+names.join(", ");}else{var event=$.EKEvent.eventWithEventStore(store);event.title=$("${s}");event.startDate=$.NSDate.dateWithTimeIntervalSince1970(new Date("${n}").getTime()/1000);event.endDate=$.NSDate.dateWithTimeIntervalSince1970(new Date("${a}").getTime()/1000);event.calendar=targetCal;var error=$();store.saveEventSpanCommitError(event,0,true,error);error.js?error.js.localizedDescription:"ok";}`;return(yield this.runJXA(d))==="ok"?(new g.Notice("\u4E8B\u4EF6\u5DF2\u6DFB\u52A0"),!0):!1})}deleteEvent(t){return u(this,null,function*(){let e=`ObjC.import("EventKit");var store=$.EKEventStore.alloc.init;var status=$.EKEventStore.authorizationStatusForEntityType(0);if(status!=3){store.requestAccessToEntityTypeCompletion(0,null);delay(2);}var event=store.eventWithIdentifier("${t}");if(!event){"event not found";}else{var error=$();store.removeEventSpanCommitError(event,0,true,error);error.js?error.js.localizedDescription:"ok";}`;return(yield this.runJXA(e))==="ok"?(new g.Notice("\u4E8B\u4EF6\u5DF2\u5220\u9664"),!0):!1})}updateEvent(t,e,n,a){return u(this,null,function*(){let r=this.escapeJXA(e),s=`ObjC.import("EventKit");var store=$.EKEventStore.alloc.init;var status=$.EKEventStore.authorizationStatusForEntityType(0);if(status!=3){store.requestAccessToEntityTypeCompletion(0,null);delay(2);}var event=store.eventWithIdentifier("${t}");if(!event){"event not found";}else{event.title=$("${r}");event.startDate=$.NSDate.dateWithTimeIntervalSince1970(new Date("${n}").getTime()/1000);event.endDate=$.NSDate.dateWithTimeIntervalSince1970(new Date("${a}").getTime()/1000);var error=$();store.saveEventSpanCommitError(event,0,true,error);error.js?error.js.localizedDescription:"ok";}`;return(yield this.runJXA(s))==="ok"?(new g.Notice("\u4E8B\u4EF6\u5DF2\u66F4\u65B0"),!0):!1})}groupEventsByDay(t){let e=[];for(let[r,s]of Object.entries(t))for(let d of s)e.push(K(N({},d),{calendar:r}));let n=new Map;for(let r of e){let s=this.getDateKey(r.start);n.has(s)||n.set(s,[]),n.get(s).push(r)}return Array.from(n.entries()).sort(([r],[s])=>r.localeCompare(s)).map(([r,s])=>({dateKey:r,label:this.getDayLabel(r),events:s.sort((d,c)=>new Date(d.start).getTime()-new Date(c.start).getTime())}))}getDateKey(t){let e=new Date(t),n=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}-${a}-${r}`}getDayLabel(t){let e=new Date,n=this.getDateKey(e.toISOString()),a=new Date(e);a.setDate(a.getDate()+1);let r=this.getDateKey(a.toISOString()),s=new Date(e);s.setDate(s.getDate()+2);let d=this.getDateKey(s.toISOString());return t===n?"\u4ECA\u5929":t===r?"\u660E\u5929":t===d?"\u540E\u5929":t.substring(5)}};var x=f(require("obsidian"));var R=f(require("obsidian")),$=class extends R.Modal{constructor(t){super(app);this.options=t}onOpen(){this.titleEl.setText("\u9009\u62E9\u65E5\u671F\u548C\u65F6\u95F4");let{contentEl:t}=this;t.empty(),t.addClass("datetime-picker-modal");let e=this.options.initialDate||new Date,n=new Date(e);n.setHours(n.getHours()+1);let a=t.createDiv("datetime-group");a.createEl("label",{text:"\u5F00\u59CB\u65F6\u95F4:"}),this.startInput=a.createEl("input",{type:"datetime-local",cls:"datetime-input"}),this.startInput.value=this.formatDateTimeLocal(e);let r=t.createDiv("datetime-group");r.createEl("label",{text:"\u7ED3\u675F\u65F6\u95F4:"}),this.endInput=r.createEl("input",{type:"datetime-local",cls:"datetime-input"}),this.endInput.value=this.formatDateTimeLocal(n);let s=t.createDiv("datetime-buttons"),d=s.createEl("button",{text:"\u53D6\u6D88",cls:"datetime-btn datetime-btn-cancel"});d.onclick=()=>this.close();let c=s.createEl("button",{text:"\u786E\u5B9A",cls:"datetime-btn datetime-btn-confirm"});c.onclick=()=>{let o=new Date(this.startInput.value),p=new Date(this.endInput.value);this.options.onSelect(o,p),this.close()}}onClose(){var t,e;(e=(t=this.options).onClose)==null||e.call(t)}formatDateTimeLocal(t){let e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0");return`${e}-${n}-${a}T${r}:${s}`}};var w="calendar-view",A=class extends x.ItemView{constructor(t,e){super(t);this.plugin=e}getViewType(){return w}getDisplayText(){return"\u65E5\u5386\u4E8B\u9879"}getIcon(){return"calendar-days"}onOpen(){return u(this,null,function*(){this.render()})}onClose(){return u(this,null,function*(){})}render(){let t=this.containerEl.children[1];t.empty(),t.addClass("calendar-view"),this.renderInputArea(t),this.renderEventsList(t)}renderInputArea(t){let n=t.createDiv("calendar-input-area").createDiv("calendar-input-wrapper"),a=n.createDiv("calendar-input-hint");a.style.display="none",a.style.fontSize="12px",a.style.color="var(--text-muted)",a.style.marginBottom="8px";let r=n.createEl("textarea",{cls:"calendar-input",attr:{placeholder:"\u6DFB\u52A0\u65E5\u5386\u4E8B\u4EF6...",rows:"2"}}),s=n.createDiv("calendar-input-actions"),d=s.createDiv("calendar-input-toolbar"),c=d.createEl("select",{cls:"calendar-select"});c.style.fontSize="12px",c.style.padding="4px 8px",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px",c.style.backgroundColor="var(--background-primary)",c.style.color="var(--text-normal)",this.plugin.storage.getCalendars().then(l=>{c.empty(),l.forEach(D=>{let k=c.createEl("option",{text:D,value:D})})});let o=null,p=null;(()=>{let l=new Date;o=new Date(l),o.setHours(o.getHours()+1,0,0,0),p=new Date(o),p.setHours(p.getHours()+1)})();let v=n.createDiv("calendar-time-display");v.style.display="none",v.style.marginTop="12px",v.style.padding="8px 12px",v.style.background="var(--background-secondary)",v.style.borderRadius="6px",v.style.fontSize="13px";let M=()=>{if(o&&p){v.style.display="block",v.innerHTML=`
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>\u{1F4C5} ${this.formatDateTime(o)} - ${this.formatTime(p.toISOString())}</span>
                        <button class="calendar-time-clear" style="padding: 2px 8px; font-size: 12px;">\u6E05\u9664</button>
                    </div>
                `;let l=v.querySelector(".calendar-time-clear");l==null||l.addEventListener("click",()=>{o=null,p=null,v.style.display="none",y.removeClass("active")})}else v.style.display="none"},y=d.createEl("button",{cls:"calendar-toolbar-btn"});y.innerHTML=`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>`,y.title="\u9009\u62E9\u65E5\u671F\u65F6\u95F4",y.onclick=()=>{this.showDateTimePicker(o||new Date,(l,D)=>{o=l,p=D,M(),y.addClass("active")})};let b=s.createDiv("calendar-action-buttons");b.style.display="flex",b.style.gap="8px";let h=b.createEl("button",{cls:"calendar-cancel-btn",text:"\u53D6\u6D88\u7F16\u8F91"});h.style.display="none";let S=b.createEl("button",{cls:"calendar-submit-btn",text:"\u6DFB\u52A0"}),E=null;h.onclick=()=>{r.value="",o=null,p=null,v.style.display="none",a.style.display="none",h.style.display="none",S.textContent="\u6DFB\u52A0",r.placeholder="\u6DFB\u52A0\u65E5\u5386\u4E8B\u4EF6...",E=null,y.removeClass("active")},S.onclick=()=>u(this,null,function*(){let l=r.value.trim();if(!l)return;let D=c.value;if(!o||!p){new Notice("\u8BF7\u8BBE\u7F6E\u65F6\u95F4");return}let k=o.toISOString(),L=p.toISOString();E?yield this.plugin.storage.updateEvent(E,l,k,L):yield this.plugin.storage.createEvent(D,l,k,L),r.value="",o=null,p=null,v.style.display="none",a.style.display="none",h.style.display="none",S.textContent="\u6DFB\u52A0",r.placeholder="\u6DFB\u52A0\u65E5\u5386\u4E8B\u4EF6...",E=null,y.removeClass("active"),yield this.loadAndRender()}),r.onkeydown=l=>{l.key==="Enter"&&!l.shiftKey?(l.preventDefault(),S.click()):l.key==="Escape"&&E&&(l.preventDefault(),h.click())},this.startEditEvent=l=>{E=l.id,r.value=l.title,o=new Date(l.start),p=new Date(l.end),M(),y.addClass("active"),a.textContent="Modifying...",a.style.display="block",h.style.display="block",S.textContent="\u4FDD\u5B58",r.placeholder="\u7F16\u8F91\u4E8B\u4EF6\u5185\u5BB9...",r.focus(),r.setSelectionRange(r.value.length,r.value.length),this.containerEl.scrollTop=0}}showDateTimePicker(t,e){new $({initialDate:t,onSelect:(a,r)=>{e(a,r)},onClose:()=>{}}).open()}renderEventsList(t){let e=t.createDiv("calendar-list-container");e.createDiv({text:"\u52A0\u8F7D\u4E2D...",cls:"calendar-loading"}),this.plugin.storage.getEvents().then(({events:n,calendars:a})=>{e.empty(),this.renderEventsContent(n,a,e)})}loadAndRender(){return u(this,null,function*(){let{events:t,calendars:e}=yield this.plugin.storage.getEvents();this.renderEventsContent(t,e)})}renderEventsContent(t,e,n){let a=n||this.containerEl.querySelector(".calendar-list-container");if(!a)return;a.empty();let r=this.plugin.storage.groupEventsByDay(t);if(r.length===0){let s=a.createDiv({cls:"calendar-empty-state"});s.createDiv({text:"\u{1F4C5}",cls:"calendar-empty-icon"}),s.createDiv({text:"\u672A\u67653\u5929\u6CA1\u6709\u65E5\u7A0B",cls:"calendar-empty-title"}),s.createDiv({text:"\u5728\u4E0A\u65B9\u8F93\u5165\u6846\u5F00\u59CB\u6DFB\u52A0",cls:"calendar-empty-desc"});return}r.forEach(s=>{this.renderDayGroup(a,s)})}renderDayGroup(t,e){let n=t.createDiv("calendar-day-group"),a=n.createDiv("calendar-day-header"),r=e.label==="\u4ECA\u5929";a.createSpan({text:e.label,cls:r?"calendar-day-label-today":"calendar-day-label"}),a.createSpan({text:`(${e.events.length})`,cls:"calendar-day-count"});let s=n.createDiv("calendar-events-list");e.events.forEach(d=>{this.renderEventItem(s,d)})}renderEventItem(t,e){let n=t.createDiv("calendar-event-item");n.dataset.eventId=e.id;let a=n.createDiv("calendar-event-card"),r=a.createDiv("calendar-event-header"),s=r.createDiv("calendar-event-time");e.allDay?s.textContent="\u5168\u5929":s.textContent=this.formatTime(e.start);let d=r.createDiv("calendar-event-badge");d.textContent=e.calendar;let o=r.createDiv("calendar-event-actions").createEl("button",{cls:"calendar-more-btn"});o.innerHTML=`<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
            <circle cx="12" cy="5" r="2"/>
            <circle cx="12" cy="12" r="2"/>
            <circle cx="12" cy="19" r="2"/>
        </svg>`,o.title="\u66F4\u591A\u64CD\u4F5C",o.onclick=m=>{m.stopPropagation(),this.showContextMenu(m,e)};let p=a.createDiv("calendar-event-body");if(p.createDiv({text:e.title,cls:"calendar-event-title"}),e.notes){let m=p.createDiv({cls:"calendar-event-meta"});m.innerHTML=`\u{1F4DD} ${e.notes}`}p.ondblclick=()=>{this.startEditEvent&&this.startEditEvent(e)},a.oncontextmenu=m=>{m.preventDefault(),this.showContextMenu(m,e)}}showContextMenu(t,e){let n=new x.Menu;n.addItem(a=>{a.setTitle("\u7F16\u8F91").setIcon("pencil").onClick(()=>{this.startEditEvent&&this.startEditEvent(e)})}),n.addItem(a=>{a.setTitle("\u5220\u9664").setIcon("trash").onClick(()=>u(this,null,function*(){confirm(`\u786E\u5B9A\u5220\u9664\u4E8B\u4EF6"${e.title}"\u5417\uFF1F`)&&(yield this.plugin.storage.deleteEvent(e.id),yield this.loadAndRender())}))}),n.showAtMouseEvent(t)}formatTime(t){let e=new Date(t),n=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0");return`${n}:${a}`}formatDateTime(t){let e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0");return`${n}-${a} ${r}:${s}`}};var O=class extends T.Plugin{onload(){return u(this,null,function*(){if(console.log("\u52A0\u8F7D\u65E5\u5386\u4E8B\u9879\u63D2\u4EF6 - macOS Calendar \u96C6\u6210"),!T.Platform.isMacOS){console.warn("\u65E5\u5386\u4E8B\u9879\u63D2\u4EF6\u4EC5\u652F\u6301 macOS \u7CFB\u7EDF");return}this.storage=new I,this.registerView(w,t=>new A(t,this)),this.addRibbonIcon("calendar-days","\u65E5\u5386\u4E8B\u9879",()=>{this.activateView()}),this.addCommand({id:"open-calendar",name:"\u6253\u5F00\u65E5\u5386\u4E8B\u9879",callback:()=>this.activateView()}),this.addCommand({id:"add-event",name:"\u5FEB\u901F\u6DFB\u52A0\u4E8B\u4EF6",callback:()=>{this.activateView()}})})}onunload(){return u(this,null,function*(){console.log("\u5378\u8F7D\u65E5\u5386\u4E8B\u9879\u63D2\u4EF6"),this.app.workspace.detachLeavesOfType(w)})}activateView(){return u(this,null,function*(){let{workspace:t}=this.app;t.detachLeavesOfType(w);let e=t.getLeaf("tab");yield e.setViewState({type:w,active:!0}),t.setActiveLeaf(e,{focus:!0})})}};
